{% extends "layouts/project_base.html" %}
{% import "components/macros.html" as ui %}
{% block title %}Runs · Unified Dashboard{% endblock %}
{% block crumb %}Runs{% endblock %}
{% block project_content %}
  {% call ui.card('Queue Run') %}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
      <label class="field">
        <span>Config</span>
        <select class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" id="config_id"></select>
      </label>
      <label class="field">
        <span>Agent</span>
        <select class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" id="agent_id"></select>
      </label>
      <label class="field sm:col-span-1">
        <span>GPUs (from agent)</span>
        <select multiple size="4" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" id="gpu_indices_sel"></select>
        <small class="text-slate-500">Hold Ctrl/Cmd to select multiple. Busy GPUs are disabled.</small>
      </label>
      <div class="sm:col-span-3"><button class="btn btn-primary" id="queue_run">Queue Run</button></div>
    </div>
  {% endcall %}

  {% call ui.card('Existing Runs') %}
    <table class="table" id="runsTable">
      <thead>
        <tr><th>Name</th><th>State</th><th>Agent</th><th>Created</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  {% endcall %}

<script>
async function fetchConfigs(){
  const res = await fetch('/api/v1/configs/project/{{ project_id }}');
  const data = await res.json();
  const sel = document.getElementById('config_id');
  sel.innerHTML='';
  data.forEach(c=>{
    const opt = document.createElement('option');
    opt.value=c.id; opt.textContent=`${c.name} v${c.version}`; sel.appendChild(opt);
  });
}
async function fetchAgents(){
  const res = await fetch('/api/v1/agents');
  const data = await res.json();
  const sel = document.getElementById('agent_id');
  sel.innerHTML='<option value="">(none)</option>';
  data.forEach(a=>{
    const opt = document.createElement('option');
    opt.value=a.id; opt.textContent=a.name; sel.appendChild(opt);
  });
}
async function fetchAgentGpus(agentId){
  const sel = document.getElementById('gpu_indices_sel');
  sel.innerHTML='';
  if(!agentId){ return; }
  try{
    const res = await fetch(`/api/v1/agents/${agentId}/gpus`);
    const gpus = await res.json();
    gpus.sort((a,b)=>a.index-b.index).forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g.index;
      opt.textContent = `GPU ${g.index}${g.name? ' — '+g.name: ''}${g.total_mem_mb? ' ('+g.total_mem_mb+'MB)': ''}${g.is_allocated? ' — busy':''}`;
      if(g.is_allocated){ opt.disabled = true; }
      sel.appendChild(opt);
    });
  }catch(e){ /* ignore */ }
}
async function fetchRuns(){
  const res = await fetch('/api/v1/runs?project_id={{ project_id }}');
  const data = await res.json();
  const tbody = document.querySelector('#runsTable tbody');
  tbody.innerHTML='';
  data.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a href="/web/runs/${r.id}">${r.name}</a></td><td><span class="status"><span class="status-dot status-${r.state}"></span>${r.state}</span></td><td>${r.agent_id? r.agent_id : ''}</td><td>${new Date(r.created_at).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('queue_run').addEventListener('click', async ()=>{
  const config = document.getElementById('config_id').value;
  const agent = document.getElementById('agent_id').value || null;
  const gpuSel = document.getElementById('gpu_indices_sel');
  const selected = Array.from(gpuSel.selectedOptions).map(o=>parseInt(o.value));
  if(selected.length>0 && !agent){ toast('Select an agent to use the chosen GPUs'); return; }
  const payload = { agent_id: agent, gpu_indices: selected };
  const res = await fetch(`/api/v1/runs/from-config/${config}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if(res.ok){ toast('Run queued'); fetchRuns(); }
});
document.getElementById('agent_id').addEventListener('change', (e)=>{
  fetchAgentGpus(e.target.value);
});
fetchConfigs();
fetchAgents();
fetchRuns();
// Populate GPUs if agent preselected (reload case)
setTimeout(()=>{
  const agent = document.getElementById('agent_id').value;
  if(agent) fetchAgentGpus(agent);
}, 0);
</script>
{% endblock %}
