{% extends "layouts/project_base.html" %}
{% import "components/macros.html" as ui %}
{% block title %}Run Details · Unified Dashboard{% endblock %}
{% block crumb %}Run{% endblock %}
{% block project_content %}
  {% call ui.card('Run Details') %}
    <div class="flex flex-wrap gap-2">
      <button class="btn" onclick="post('/api/v1/runs/{{ run_id }}/start')">Start</button>
      <button class="btn btn-primary" onclick="post('/api/v1/runs/{{ run_id }}/finish?success=true')">Mark Succeeded</button>
      <button class="btn btn-warn" onclick="post('/api/v1/runs/{{ run_id }}/finish?success=false')">Mark Failed</button>
      <button class="btn btn-danger" onclick="post('/api/v1/runs/{{ run_id }}/cancel')">Cancel</button>
    </div>
    <pre class="mt-3" id="meta"></pre>
  {% endcall %}

  {% call ui.card('Agent Status') %}
    <div id="agent_status">Loading…</div>
    <div class="mt-3">
      <button class="btn btn-danger" id="halt_btn">Halt Current Training</button>
    </div>
  {% endcall %}

  {% call ui.card('Logs') %}
    <pre id="logs"></pre>
  {% endcall %}

  {% call ui.card('TensorBoard') %}
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-slate-600 dark:text-slate-300">Live metrics</div>
      <button class="btn btn-ghost" id="tb_expand_btn" type="button">⤢ Expand</button>
    </div>
    <div class="h-[70vh] w-full border rounded-md overflow-hidden bg-white dark:bg-slate-900" id="tb_card_container">
      <div id="tb_placeholder" class="p-3 text-sm text-slate-600 dark:text-slate-300">Starting TensorBoard for this run…</div>
      <iframe id="tb_frame" class="hidden h-full w-full" src="" referrerpolicy="no-referrer"></iframe>
    </div>
  {% endcall %}

  <!-- Fullscreen TensorBoard overlay -->
  <div id="tb_overlay" class="hidden fixed inset-0 z-50 bg-slate-900/80">
    <div class="absolute inset-4 bg-white dark:bg-slate-900 rounded-md shadow-2xl overflow-hidden flex flex-col">
      <div class="p-2 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
        <div class="text-sm font-medium">TensorBoard — Full View</div>
        <div class="space-x-2">
          <a id="tb_open_new" target="_blank" class="btn btn-ghost">↗ Open in new tab</a>
          <button class="btn" id="tb_close_btn" type="button">✕ Close</button>
        </div>
      </div>
      <div class="flex-1">
        <iframe id="tb_frame_full" class="h-full w-full" src="" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>
<script>
async function post(url){ const r = await fetch(url, {method:'POST'}); if(r.ok) toast('Updated'); await refresh(); }
async function refresh(){
  const res = await fetch('/api/v1/runs/{{ run_id }}');
  const r = await res.json();
  document.getElementById('meta').textContent = JSON.stringify(r, null, 2);
  // Agent status
  try {
    const sr = await fetch('/api/v1/runs/{{ run_id }}/status');
    if (sr.ok) {
      const s = await sr.json();
      const eta = (s.eta_seconds!=null)? (Math.round(s.eta_seconds)) : null;
      const el = (s.elapsed_seconds!=null)? (Math.round(s.elapsed_seconds)) : null;
      document.getElementById('agent_status').textContent =
        s.state==='running'
          ? `Running — epoch ${s.epoch+1}/${s.total_epochs} · elapsed ${el}s · ETA ${eta}s`
          : 'Idle';
    } else {
      document.getElementById('agent_status').textContent = 'Agent unreachable';
    }
  } catch (e) {
    document.getElementById('agent_status').textContent = 'Agent unreachable';
  }
  const lr = await fetch('/api/v1/runs/{{ run_id }}/logs?tail=200');
  const logs = await lr.json();
  document.getElementById('logs').textContent = (logs.lines||[]).join('\n');
  // Ensure TensorBoard is available and embed it
  try {
    const tr = await fetch('/api/v1/runs/{{ run_id }}/tensorboard');
    if (tr.ok) {
      const data = await tr.json();
      const url = data.url.endsWith('/') ? data.url : data.url + '/';
      const frame = document.getElementById('tb_frame');
      const ph = document.getElementById('tb_placeholder');
      frame.src = url + '#scalars';
      frame.classList.remove('hidden');
      if (ph) ph.remove();
      // Update overlay targets
      const full = document.getElementById('tb_frame_full');
      const openNew = document.getElementById('tb_open_new');
      if(full && !full.src) full.src = url + '#scalars';
      if(openNew) openNew.href = '/web/tensorboard/{{ run_id }}';
    }
  } catch (e) { /* ignore */ }
}
refresh();
setInterval(refresh, 5000);
document.getElementById('halt_btn').addEventListener('click', async ()=>{
  const r = await fetch('/api/v1/runs/{{ run_id }}/halt', {method:'POST'});
  if(r.ok) toast('Halt requested');
});
// TB expand/collapse
document.getElementById('tb_expand_btn').addEventListener('click', ()=>{
  const overlay = document.getElementById('tb_overlay');
  // Sync URLs in case changed
  const small = document.getElementById('tb_frame');
  const full = document.getElementById('tb_frame_full');
  if(small && full && small.src && full.src !== small.src){ full.src = small.src; }
  overlay.classList.remove('hidden');
  _fullVisible = true;
});
document.getElementById('tb_close_btn').addEventListener('click', ()=>{
  const overlay = document.getElementById('tb_overlay');
  overlay.classList.add('hidden');
  _fullVisible = false;
});

// --- TensorBoard heartbeat to control lifecycle ---
let _hbTimer = null;
let _smallVisible = false;
let _fullVisible = false;
const _runId = '{{ run_id }}';

function _sendHeartbeat() {
  return fetch('/api/v1/tensorboard/heartbeat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    // keepalive allows the browser to send the request during unload
    keepalive: true,
    body: JSON.stringify({ run_id: _runId })
  }).catch(()=>{});
}

function _updateHeartbeatLoop() {
  if (_hbTimer) { clearInterval(_hbTimer); _hbTimer = null; }
  const tick = () => {
    const pageVisible = document.visibilityState === 'visible';
    if (pageVisible && (_smallVisible || _fullVisible)) {
      _sendHeartbeat();
    }
  };
  // initial ping if visible
  tick();
  _hbTimer = setInterval(tick, 10_000);
}

// Observe if the small TB iframe is actually visible in viewport
const _tbFrame = document.getElementById('tb_frame');
const _obs = new IntersectionObserver((entries) => {
  entries.forEach((e) => {
    _smallVisible = e.isIntersecting && !_tbFrame.classList.contains('hidden');
  });
}, { root: null, threshold: 0.01 });
if (_tbFrame) _obs.observe(_tbFrame);

document.addEventListener('visibilitychange', _updateHeartbeatLoop);
window.addEventListener('beforeunload', () => {
  try {
    if (navigator.sendBeacon) {
      const blob = new Blob([JSON.stringify({ run_id: _runId })], { type: 'application/json' });
      navigator.sendBeacon('/api/v1/tensorboard/heartbeat', blob);
    }
  } catch (_) { /* ignore */ }
});

// Start the heartbeat loop now
_updateHeartbeatLoop();
</script>
{% endblock %}
