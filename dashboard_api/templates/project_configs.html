{% extends "layouts/project_base.html" %}
{% import "components/macros.html" as ui %}
{% block title %}Configs · Unified Dashboard{% endblock %}
{% block crumb %}Configs{% endblock %}
{% block project_content %}
<section>
  <h2 class="muted">Configs</h2>
  {% call ui.card('Create Config') %}
    <form id="builder" class="grid grid-cols-1 gap-4 sm:grid-cols-2">
      <input type="hidden" name="project_id" value="{{ project_id }}" />

      <h3 class="grid-span">Basic</h3>
      <label class="field">
        <span>Name</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="name" placeholder="My Config" required />
      </label>
      <label class="field">
        <span>Dataset</span>
        <select id="dataset_select" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700"></select>
      </label>
      <label class="field sm:col-span-2">
        <span>Dataset root (if not in list)</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="root" placeholder="/datasets/path" />
      </label>
      <label class="field">
        <span>Model</span>
        <select id="model_select" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700"></select>
      </label>
      <label class="field">
        <span>Model flavour (override)</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="model_flavour" placeholder="google/vit-base-patch16-224" />
      </label>
      <label class="field">
        <span>Loss</span>
        <select name="loss_name" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700">
          <option value="CE">CE</option>
        </select>
      </label>

      <h3 class="grid-span">Optimization</h3>
      <label class="field">
        <span>Optimizer</span>
        <select name="optimizer" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700">
          <option value="adam">adam</option>
          <option value="adamw">adamw</option>
        </select>
      </label>
      <label class="field">
        <span>Learning rate</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="lr" type="number" step="0.000001" value="0.001" />
      </label>
      <label class="field">
        <span>Weight decay</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="weight_decay" type="number" step="0.0001" value="0.05" />
      </label>
      <label class="field">
        <span>Grad clip (max norm)</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="max_grad_norm" type="number" step="0.1" value="1.0" />
      </label>
      <label class="field">
        <span>Warmup ratio</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="warmup_ratio" type="number" step="0.01" value="0.05" />
      </label>
      <label class="field">
        <span>Grad accum steps</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="grad_accum_steps" type="number" step="1" value="1" />
      </label>
      <label class="field">
        <span>Epochs</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="epochs" type="number" step="1" value="10" />
      </label>
      <label class="field">
        <span>Seed</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="seed" type="number" step="1" value="42" />
      </label>
      <label class="field">
        <span>Autocast dtype</span>
        <select name="autocast_dtype" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700">
          <option value="torch.bfloat16">torch.bfloat16</option>
          <option value="torch.float16">torch.float16</option>
          <option value="torch.float32">torch.float32</option>
        </select>
      </label>

      <h3 class="grid-span">Data loader</h3>
      <label class="field">
        <span>Batch size</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="batch_size" type="number" step="1" value="256" />
      </label>
      <label class="field">
        <span>Workers</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="num_workers" type="number" step="1" value="4" />
      </label>
      <label class="field">
        <span>Prefetch factor</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="prefetch_factor" type="number" step="1" value="4" />
      </label>
      <label class="field">
        <span>Persistent workers</span>
        <input name="persistent_workers" type="checkbox" />
      </label>
      <label class="field sm:col-span-2">
        <span>Max datapoints per class</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="max_datapoints_per_class" type="number" step="1" value="10000" />
      </label>

      <h3 class="grid-span">Logging & Checkpoints</h3>
      <label class="field">
        <span>TB root</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="tb_root" value="runs" />
      </label>
      <label class="field">
        <span>CKPT dir</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="ckpt_dir" value="checkpoints" />
      </label>
      <label class="field">
        <span>Monitor metric</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="monitor_metric" value="val_acc@1" />
      </label>
      <label class="field">
        <span>Monitor mode</span>
        <select name="monitor_mode" class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700">
          <option value="max">max</option>
          <option value="min">min</option>
        </select>
      </label>
      <label class="field">
        <span>Per-epoch ckpt</span>
        <input name="save_per_epoch_checkpoint" type="checkbox" />
      </label>
      <label class="field">
        <span>Eval top-k (comma)</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="eval_topk" value="3,5" />
      </label>
      <label class="field">
        <span>Model suffix</span>
        <input class="block w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-slate-800 dark:border-slate-700" name="model_suffix" value="" />
      </label>
      <label class="field">
        <span>Load pretrained</span>
        <input name="load_pretrained" type="checkbox" checked />
      </label>
      <label class="field">
        <span>Freeze backbone</span>
        <input name="freeze_backbone" type="checkbox" />
      </label>

      <div class="sm:col-span-2 flex gap-2">
        <button type="button" class="btn" id="preview_btn">Preview JSON</button>
        <button type="submit" class="btn primary" id="create_btn">Create Config</button>
      </div>

      <details class="sm:col-span-2">
        <summary>JSON Preview (editable)</summary>
        <textarea id="json_preview" rows="12" class="mt-2 w-full rounded-lg border px-3 py-2"></textarea>
      </details>
    </form>
  {% endcall %}

  {% call ui.card('Existing Configs') %}
    <table class="table" id="cfgTable"><thead><tr><th>Name</th><th>Version</th><th>Status</th><th>Created</th></tr></thead><tbody></tbody></table>
  {% endcall %}
</section>
{% endblock %}

{% block scripts %}
<script>
function parseIntOr(val, def){ const n = parseInt(val); return isNaN(n)?def:n; }
function parseFloatOr(val, def){ const n = parseFloat(val); return isNaN(n)?def:n; }
function buildConfig(){
  const form = document.getElementById('builder');
  const fd = new FormData(form);
  const dsSel = document.getElementById('dataset_select');
  const modelSel = document.getElementById('model_select');
  const rootSel = dsSel.value || '';
  const rootOverride = fd.get('root') || '';
  const modelSelVal = modelSel.value || '';
  const modelOverride = fd.get('model_flavour') || '';
  const evalTopk = (fd.get('eval_topk')||'').split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
  const cfg = {
    root: rootOverride || rootSel,
    model_flavour: modelOverride || modelSelVal,
    loss_name: fd.get('loss_name')||'CE',
    batch_size: parseIntOr(fd.get('batch_size'), 256),
    num_workers: parseIntOr(fd.get('num_workers'), 4),
    prefetch_factor: parseIntOr(fd.get('prefetch_factor'), 4),
    persistent_workers: !!fd.get('persistent_workers'),
    epochs: parseIntOr(fd.get('epochs'), 10),
    optimizer: fd.get('optimizer')||'adam',
    lr: parseFloatOr(fd.get('lr'), 0.001),
    weight_decay: parseFloatOr(fd.get('weight_decay'), 0.05),
    max_grad_norm: parseFloatOr(fd.get('max_grad_norm'), 1.0),
    warmup_ratio: parseFloatOr(fd.get('warmup_ratio'), 0.05),
    grad_accum_steps: parseIntOr(fd.get('grad_accum_steps'), 1),
    seed: parseIntOr(fd.get('seed'), 42),
    autocast_dtype: fd.get('autocast_dtype')||'torch.bfloat16',
    load_pretrained: !!fd.get('load_pretrained'),
    run_name: null,
    tb_root: fd.get('tb_root')||'runs',
    eval_topk: evalTopk.length?evalTopk:[3,5],
    model_suffix: fd.get('model_suffix')||'',
    freeze_backbone: !!fd.get('freeze_backbone'),
    ckpt_dir: fd.get('ckpt_dir')||'checkpoints',
    monitor_metric: fd.get('monitor_metric')||'val_acc@1',
    monitor_mode: fd.get('monitor_mode')||'max',
    save_per_epoch_checkpoint: !!fd.get('save_per_epoch_checkpoint'),
    max_datapoints_per_class: parseIntOr(fd.get('max_datapoints_per_class'), 10000)
  };
  return cfg;
}

function renderPreview(){
  const cfg = buildConfig();
  document.getElementById('json_preview').value = JSON.stringify(cfg, null, 2);
}

async function fetchConfigs(){
  const res = await fetch('/api/v1/configs/project/{{ project_id }}');
  const data = await res.json();
  const tbody = document.querySelector('#cfgTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  data.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td><td>${c.version}</td><td>${c.status}</td><td>${new Date(c.created_at).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}

async function fetchDatasets(){
  const res = await fetch('/api/v1/projects/{{ project_id }}/datasets');
  const data = await res.json();
  const sel = document.getElementById('dataset_select');
  sel.innerHTML = '<option value="">(custom)</option>';
  data.forEach(d=>{
    const opt = document.createElement('option');
    opt.value=d.root_path; opt.textContent = `${d.name} — ${d.root_path}`;
    sel.appendChild(opt);
  });
}

async function fetchModels(){
  const res = await fetch('/api/v1/projects/{{ project_id }}/models');
  const data = await res.json();
  const sel = document.getElementById('model_select');
  sel.innerHTML = '<option value="">(custom)</option>';
  data.forEach(m=>{
    const opt = document.createElement('option');
    opt.value=m.hf_checkpoint_id; opt.textContent = `${m.label} — ${m.hf_checkpoint_id}`;
    sel.appendChild(opt);
  });
}

document.getElementById('preview_btn').addEventListener('click', (e)=>{
  e.preventDefault();
  renderPreview();
});

document.getElementById('create_btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const fd = new FormData(document.getElementById('builder'));
  const name = fd.get('name');
  const cfg = buildConfig();
  const payload = { project_id: fd.get('project_id'), name, config_json: cfg };
  const r = await fetch('/api/v1/configs', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if(r.ok){ toast('Config created'); fetchConfigs(); }
});

fetchConfigs();
fetchDatasets();
fetchModels();
renderPreview();
</script>
{% endblock %}
