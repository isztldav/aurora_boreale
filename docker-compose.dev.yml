services:
  db:
    ports:
      - "5432:5432"
  
  web:
    command: >
      bash -lc "uvicorn src.dashboard.app:app --host 0.0.0.0 --port 8000 --reload \
      --reload-dir /app/src \
      --reload-include '*.py' \
      --log-level debug"
    environment:
      DASHBOARD_DEBUG: "1"

  agent:
    # Enable code reload using uvicorn factory; pass GPU index via env
    command: bash -lc "uvicorn agent.server:create_app --host 0.0.0.0 --port 7070 --reload --factory"

  ui:
    image: node:20-alpine
    container_name: dashboard-ui
    working_dir: /app
    volumes:
      - ./web_ui:/app
    environment:
      # Use reverse-proxied relative API path so browser hits Nginx and Nginx hits backend
      NEXT_PUBLIC_API_BASE: /api/v1
    command: sh -lc "npm install && npm run dev -- -p 3000"
    # Do not expose UI directly; Nginx will reverse proxy it
    depends_on:
      - web

  nginx:
    image: nginx:alpine
    container_name: dashboard-nginx
    depends_on:
      - ui
      - web
    volumes:
      - ./deploy/nginx/ui.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
